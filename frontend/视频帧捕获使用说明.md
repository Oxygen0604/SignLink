# 视频帧捕获使用说明

## 概述

本文档说明如何在 React Native 中从摄像头获取视频帧，转换为 Base64 格式，并通过 WebSocket 传输图像数据。

## 实现方案

### 方案1: 使用 react-native-view-shot（推荐用于简单场景）

使用 `react-native-view-shot` 库从 RTCView 截图。

**优点：**
- 实现简单
- 不需要原生模块

**缺点：**
- 性能较差（每秒只能截图几次）
- 可能不支持所有视图类型
- 资源消耗较大

### 方案2: 使用原生模块（推荐用于生产环境）

创建原生模块直接从 VideoTrack 捕获帧。

**优点：**
- 性能好
- 资源消耗低
- 可以高频率捕获帧

**缺点：**
- 需要编写原生代码
- 实现复杂度较高

### 方案3: 使用 Web 环境（仅限 Web 平台）

在 Web 环境中使用 ImageCapture API 或 Canvas API。

## 当前实现

当前代码使用 `react-native-view-shot` 方案。如果遇到问题，可以考虑：

1. **优化捕获频率**：减少捕获频率（例如每500ms一次）
2. **使用原生模块**：创建原生模块直接从 VideoTrack 捕获
3. **使用其他库**：考虑使用 `react-native-vision-camera` 等库

## 使用方法

### 1. 安装依赖

```bash
npm install react-native-view-shot react-native-fs
```

### 2. 在组件中使用

```typescript
import { captureFrameFromStream } from '../../utils/videoCapture';

// 创建视图引用
const cameraViewRef = useRef<any>(null);

// 捕获帧
const base64Image = await captureFrameFromStream(localStream, cameraViewRef);
```

### 3. 通过 WebSocket 发送

```typescript
import { useTranslationStore } from '../../store/translationStore';

const { sendImage } = useTranslationStore();

// 发送图像数据
sendImage(base64Image);
```

## 注意事项

1. **性能优化**：
   - 建议捕获频率不超过每200ms一次
   - 可以根据网络情况调整频率
   - 考虑压缩图像大小

2. **内存管理**：
   - 及时清理定时器
   - 避免内存泄漏
   - 注意 Base64 数据大小

3. **错误处理**：
   - 处理捕获失败的情况
   - 处理 WebSocket 连接失败的情况
   - 添加重试机制

4. **平台差异**：
   - iOS 和 Android 可能有不同的表现
   - 测试不同设备上的性能
   - 根据平台优化

## 替代方案

如果 `react-native-view-shot` 无法正常工作，可以考虑：

1. **使用 react-native-vision-camera**：
   - 提供更好的性能
   - 支持帧处理器
   - 需要重构代码

2. **创建原生模块**：
   - 直接从 VideoTrack 捕获帧
   - 性能最佳
   - 需要原生开发经验

3. **使用后端轮询**：
   - 前端定期上传图像到后端
   - 使用 HTTP 而不是 WebSocket
   - 实现简单但性能较差

## 故障排查

1. **无法捕获帧**：
   - 检查视图引用是否正确
   - 检查 react-native-view-shot 是否安装
   - 检查权限是否获取

2. **性能问题**：
   - 减少捕获频率
   - 优化图像大小
   - 考虑使用原生模块

3. **WebSocket 连接问题**：
   - 检查后端服务是否运行
   - 检查网络连接
   - 查看错误日志

