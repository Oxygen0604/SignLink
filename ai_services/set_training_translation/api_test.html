<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ‰‹è¯­è¯†åˆ« API æµ‹è¯•é¡µé¢</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        text-align: center;
        color: #667eea;
        margin-bottom: 10px;
        font-size: 2.5em;
      }

      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
        font-size: 1.1em;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
      }

      .section h2 {
        color: #667eea;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .api-status {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .status-card {
        flex: 1;
        min-width: 200px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
        text-align: center;
      }

      .status-card h3 {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 8px;
      }

      .status-card .value {
        font-size: 1.5em;
        font-weight: bold;
        color: #667eea;
      }

      .status-card.healthy .value {
        color: #4caf50;
      }

      .status-card.error .value {
        color: #f44336;
      }

      .video-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }

      .video-box {
        flex: 1;
        text-align: center;
      }

      .video-box h3 {
        margin-bottom: 10px;
        color: #333;
      }

      video,
      .image-display {
        width: 100%;
        max-width: 400px;
        border: 3px solid #667eea;
        border-radius: 10px;
        background: #000;
      }

      .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 30px;
        font-size: 1em;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
        background: #4caf50;
        color: white;
      }

      .btn-success:hover {
        background: #45a049;
      }

      .btn-danger {
        background: #f44336;
        color: white;
      }

      .btn-danger:hover {
        background: #da190b;
      }

      .btn-secondary {
        background: #9e9e9e;
        color: white;
      }

      .btn-secondary:hover {
        background: #7e7e7e;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .result-display {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .result-item {
        padding: 15px;
        background: #f0f4ff;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .result-item .label {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
      }

      .result-item .value {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
      }

      .log-container {
        background: #1e1e1e;
        color: #00ff00;
        padding: 15px;
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
      }

      .log-entry {
        margin-bottom: 5px;
      }

      .log-entry .timestamp {
        color: #888;
      }

      .settings {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .setting-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .setting-item label {
        font-weight: bold;
        color: #333;
      }

      input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      input[type="text"] {
        padding: 8px;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        font-size: 1em;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: bold;
      }

      .badge-success {
        background: #4caf50;
        color: white;
      }

      .badge-error {
        background: #f44336;
        color: white;
      }

      .badge-warning {
        background: #ff9800;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸš€ æ‰‹è¯­è¯†åˆ« API æµ‹è¯•</h1>
      <p class="subtitle">æµ‹è¯•å’Œæ¼”ç¤ºæ‰‹è¯­è¯†åˆ« API çš„å„é¡¹åŠŸèƒ½</p>

      <!-- API çŠ¶æ€ -->
      <div class="section">
        <h2>ğŸ“Š API çŠ¶æ€</h2>
        <div class="api-status">
          <div class="status-card" id="statusCard">
            <h3>æœåŠ¡çŠ¶æ€</h3>
            <div class="value">æ£€æŸ¥ä¸­...</div>
          </div>
          <div class="status-card">
            <h3>æ”¯æŒç±»åˆ«</h3>
            <div class="value" id="numClasses">-</div>
          </div>
          <div class="status-card">
            <h3>è¿è¡Œæ—¶é—´</h3>
            <div class="value" id="uptime">-</div>
          </div>
          <div class="status-card">
            <h3>è¯·æ±‚æ¬¡æ•°</h3>
            <div class="value" id="requestCount">-</div>
          </div>
        </div>
        <button class="btn-secondary" onclick="checkAPIHealth()">
          åˆ·æ–°çŠ¶æ€
        </button>
      </div>

      <!-- è§†é¢‘æµ‹è¯• -->
      <div class="section">
        <h2>ğŸ“¹ å®æ—¶è¯†åˆ«æµ‹è¯•</h2>

        <!-- è®¾ç½® -->
        <div class="settings">
          <div class="setting-item">
            <label>API åœ°å€:</label>
            <input
              type="text"
              id="apiUrl"
              value="http://localhost:5000"
              style="width: 250px"
            />
          </div>
          <div class="setting-item">
            <input type="checkbox" id="drawLandmarks" checked />
            <label for="drawLandmarks">ç»˜åˆ¶æ‰‹éƒ¨å…³é”®ç‚¹</label>
          </div>
          <div class="setting-item">
            <input type="checkbox" id="returnAllProbs" />
            <label for="returnAllProbs">è¿”å›æ‰€æœ‰æ¦‚ç‡</label>
          </div>
        </div>

        <!-- è§†é¢‘æ˜¾ç¤º -->
        <div class="video-container">
          <div class="video-box">
            <h3>ğŸ“· æ‘„åƒå¤´ç”»é¢</h3>
            <video id="video" width="400" height="300" autoplay></video>
          </div>
          <div class="video-box">
            <h3>ğŸ–¼ï¸ è¯†åˆ«ç»“æœ</h3>
            <img
              id="resultImage"
              class="image-display"
              src=""
              alt="è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ"
              style="display: none"
            />
            <div
              id="noResultPlaceholder"
              style="
                width: 400px;
                height: 300px;
                border: 3px solid #667eea;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #999;
              "
            >
              ç­‰å¾…è¯†åˆ«...
            </div>
          </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="controls">
          <button class="btn-primary" onclick="startCamera()">
            ğŸ¥ å¯åŠ¨æ‘„åƒå¤´
          </button>
          <button
            class="btn-success"
            onclick="startRecognition()"
            id="startBtn"
            disabled
          >
            â–¶ï¸ å¼€å§‹è¯†åˆ«
          </button>
          <button
            class="btn-danger"
            onclick="stopRecognition()"
            id="stopBtn"
            disabled
          >
            â¹ï¸ åœæ­¢è¯†åˆ«
          </button>
          <button class="btn-secondary" onclick="captureOnce()">
            ğŸ“¸ å•æ¬¡è¯†åˆ«
          </button>
        </div>

        <!-- è¯†åˆ«ç»“æœ -->
        <div class="result-display">
          <div class="result-item">
            <div class="label">è¯†åˆ«å•è¯</div>
            <div class="value" id="detectedWord">-</div>
          </div>
          <div class="result-item">
            <div class="label">ç½®ä¿¡åº¦</div>
            <div class="value" id="confidence">-</div>
          </div>
          <div class="result-item">
            <div class="label">è¯†åˆ«æ¬¡æ•°</div>
            <div class="value" id="detectionCount">0</div>
          </div>
          <div class="result-item">
            <div class="label">å¹³å‡ç½®ä¿¡åº¦</div>
            <div class="value" id="avgConfidence">-</div>
          </div>
        </div>
      </div>

      <!-- æ—¥å¿— -->
      <div class="section">
        <h2>ğŸ“ è¯·æ±‚æ—¥å¿—</h2>
        <div class="log-container" id="logContainer">
          <div class="log-entry">ç­‰å¾…è¯·æ±‚...</div>
        </div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      const video = document.getElementById("video");
      const resultImage = document.getElementById("resultImage");
      let recognitionInterval = null;
      let totalDetections = 0;
      let totalConfidence = 0;

      // è®°å½•æ—¥å¿—
      function addLog(message, type = "info") {
        const logContainer = document.getElementById("logContainer");
        const timestamp = new Date().toLocaleTimeString();
        const color =
          type === "error"
            ? "#ff5252"
            : type === "success"
            ? "#4caf50"
            : "#00ff00";

        const logEntry = document.createElement("div");
        logEntry.className = "log-entry";
        logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span style="color: ${color}">${message}</span>`;

        logContainer.insertBefore(logEntry, logContainer.firstChild);

        // é™åˆ¶æ—¥å¿—æ•°é‡
        if (logContainer.children.length > 50) {
          logContainer.removeChild(logContainer.lastChild);
        }
      }

      // æ£€æŸ¥ API å¥åº·çŠ¶æ€
      async function checkAPIHealth() {
        const apiUrl = document.getElementById("apiUrl").value;
        addLog("æ­£åœ¨æ£€æŸ¥ API çŠ¶æ€...");

        try {
          // å¥åº·æ£€æŸ¥
          const healthResponse = await fetch(`${apiUrl}/api/health`);
          const healthData = await healthResponse.json();

          const statusCard = document.getElementById("statusCard");
          if (healthData.status === "healthy") {
            statusCard.classList.add("healthy");
            statusCard.querySelector(".value").innerHTML = "âœ… æ­£å¸¸";
            addLog("API æœåŠ¡æ­£å¸¸", "success");
          } else {
            statusCard.classList.add("error");
            statusCard.querySelector(".value").innerHTML = "âŒ å¼‚å¸¸";
            addLog("API æœåŠ¡å¼‚å¸¸", "error");
          }

          document.getElementById("uptime").textContent =
            Math.floor(healthData.uptime_seconds) + "s";
          document.getElementById("requestCount").textContent =
            healthData.request_count;

          // è·å–æ¨¡å‹ä¿¡æ¯
          const infoResponse = await fetch(`${apiUrl}/api/info`);
          const infoData = await infoResponse.json();

          if (infoData.success) {
            document.getElementById("numClasses").textContent =
              infoData.model_info.num_classes;
            addLog(
              `æ¨¡å‹æ”¯æŒ ${
                infoData.model_info.num_classes
              } ä¸ªç±»åˆ«: ${infoData.model_info.classes.join(", ")}`,
              "success"
            );
          }
        } catch (error) {
          addLog(`API è¿æ¥å¤±è´¥: ${error.message}`, "error");
          const statusCard = document.getElementById("statusCard");
          statusCard.classList.add("error");
          statusCard.querySelector(".value").innerHTML = "âŒ æ— æ³•è¿æ¥";
        }
      }

      // å¯åŠ¨æ‘„åƒå¤´
      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480 },
          });
          video.srcObject = stream;
          document.getElementById("startBtn").disabled = false;
          addLog("æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ", "success");
        } catch (error) {
          addLog(`æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ${error.message}`, "error");
          alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®");
        }
      }

      // æ•è·å½“å‰å¸§
      function captureFrame() {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        return canvas.toDataURL("image/jpeg", 0.8);
      }

      // è°ƒç”¨è¯†åˆ« API
      async function recognizeSign(imageData) {
        const apiUrl = document.getElementById("apiUrl").value;
        const drawLandmarks = document.getElementById("drawLandmarks").checked;
        const returnAllProbs =
          document.getElementById("returnAllProbs").checked;

        try {
          const response = await fetch(`${apiUrl}/api/predict`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              image: imageData,
              draw_landmarks: drawLandmarks,
              return_all_probs: returnAllProbs,
            }),
          });

          const result = await response.json();

          if (result.success && result.detected) {
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById("detectedWord").textContent = result.word;
            document.getElementById("confidence").textContent =
              (result.confidence * 100).toFixed(1) + "%";

            // æ›´æ–°ç»Ÿè®¡
            totalDetections++;
            totalConfidence += result.confidence;
            document.getElementById("detectionCount").textContent =
              totalDetections;
            document.getElementById("avgConfidence").textContent =
              ((totalConfidence / totalDetections) * 100).toFixed(1) + "%";

            // æ˜¾ç¤ºæ ‡æ³¨å›¾åƒ
            if (result.annotated_image) {
              resultImage.src = result.annotated_image;
              resultImage.style.display = "block";
              document.getElementById("noResultPlaceholder").style.display =
                "none";
            }

            addLog(
              `è¯†åˆ«æˆåŠŸ: ${result.word} (${(result.confidence * 100).toFixed(
                1
              )}%)`,
              "success"
            );

            // å¦‚æœè¿”å›äº†æ‰€æœ‰æ¦‚ç‡ï¼Œè®°å½•åˆ°æ—¥å¿—
            if (result.all_predictions) {
              const probs = Object.entries(result.all_predictions)
                .map(([word, prob]) => `${word}: ${(prob * 100).toFixed(1)}%`)
                .join(", ");
              addLog(`æ‰€æœ‰æ¦‚ç‡: ${probs}`);
            }
          } else {
            document.getElementById("detectedWord").textContent = "æœªæ£€æµ‹åˆ°";
            document.getElementById("confidence").textContent = "-";
            addLog("æœªæ£€æµ‹åˆ°æ‰‹éƒ¨", "error");
          }
        } catch (error) {
          addLog(`API è°ƒç”¨å¤±è´¥: ${error.message}`, "error");
        }
      }

      // å•æ¬¡è¯†åˆ«
      async function captureOnce() {
        addLog("æ‰§è¡Œå•æ¬¡è¯†åˆ«...");
        const imageData = captureFrame();
        await recognizeSign(imageData);
      }

      // å¼€å§‹æŒç»­è¯†åˆ«
      function startRecognition() {
        if (recognitionInterval) return;

        addLog("å¼€å§‹æŒç»­è¯†åˆ« (5 FPS)...", "success");
        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;

        recognitionInterval = setInterval(async () => {
          const imageData = captureFrame();
          await recognizeSign(imageData);
        }, 200); // 5 FPS
      }

      // åœæ­¢è¯†åˆ«
      function stopRecognition() {
        if (recognitionInterval) {
          clearInterval(recognitionInterval);
          recognitionInterval = null;
          addLog("åœæ­¢è¯†åˆ«", "success");
        }

        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
      }

      // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ API çŠ¶æ€
      window.addEventListener("load", () => {
        checkAPIHealth();
      });
    </script>
  </body>
</html>
